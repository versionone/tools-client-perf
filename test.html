<html>
<head>
<script type='text/javascript' src='../scripts/jQuery.js'></script>
<script type='text/javascript'>
	var scenarios = []
	function setup(s) { s.burn = true; scenarios.push(s) }
	function scenario(s) { scenarios.push(s) }

	var defaults = {
		minRounds: 3,
		maxRounds: 15,
		targetInterval: 0.05,
		url: "Default.aspx",
		parameters: {}
	}

	Number.prototype.round = function round(places) {
		var pow10 = Math.pow(10, places || 0)
		return Math.round(this * pow10) / pow10
	}

	Number.prototype.toPercent = function toPercent(places) {
		var pow10 = Math.pow(10, places || 0)
		return Math.round(this * pow10 * 100) / pow10 + '%'
	}

	String.prototype.qparm = function qparm(name) {
		var match = new RegExp("\\?.*\\b" + name + "=([^&]+)").exec(this)
		if (match) return match[1]
	}

	$.fn.fadeAway = function fadeAway(elapse) {
		var t = this
		t.fadeOut(elapse, function () { t.remove() })
		return this
	}

	function Aspect(target, methodName) {
		function makeStub(coreFn) {
			var beforeFns = []
			var afterFns = []

			var stubFn = function stubFn() {
				for (var i in beforeFns)
					beforeFns[i].apply(this, arguments)
				coreFn.apply(this, arguments)
				for (var i in afterFns)
					afterFns[i].apply(this, arguments)
			}

			stubFn.before = function(beforeFn) {
				beforeFns.unshift(beforeFn)
				return this
			}

			stubFn.after = function(afterFn) {
				afterFns.unshift(afterFn)
				return this
			}

			stubFn.isStub = true
			return stubFn
		}

		var fn = target[methodName] || function(){}
		if (!fn.isStub) target[methodName] = fn = makeStub(fn)
		return fn			
	}

	function Stats() {
		var _values = []

		function _count() { return _values.length }

		function _medianOf(sortedArray) {
			var lowerMedianIndex = Math.floor((sortedArray.length - 1) / 2.0)
			var upperMedianIndex = Math.ceil((sortedArray.length - 1) / 2.0)
			return (sortedArray[lowerMedianIndex] + sortedArray[upperMedianIndex]) / 2.0
		}

		function _median() { return _medianOf(_values) }

		function project(array, projection) {
			var output = []
			for (var index in array) output.push(projection(array[index]))
			return output
		}

		function numerically(a, b) {return a - b}

		function _medianDeviation() {
			var median = _median()
			function absoluteDeviation(value) {return Math.abs(value - median)}
			var deviations = project(_values, absoluteDeviation).sort(numerically)
			return _medianOf(deviations)
		}

		function _interval() { return _medianDeviation() / _median() }

		this.accumulate = function accumulate(value) {
			var index = 0
			while (index < _values.length && _values[index] <= value)
				++index
			_values.splice(index, 0, value)
		}

		this.count = function count() { return _count() }

		this.median = function median() { if (_count()) return _median() }

		this.medianDeviation = function medianDeviation() { if (_count()) return _medianDeviation() }

		this.interval = function interval() { if (_count()) return _interval() }
	}

</script>
<script type='text/javascript' src='parameters.js'></script>
<script type='text/javascript' src='scenarios.js'></script>
<script type='text/javascript'>

	$(function () {
		var statusDiv = $('#status')
		function status(message, h) {
			tag = 'h' + (h || 1)
			statusDiv.find(tag).text(message)
		}

		var logEntry = $('#log .entry')
		var logEntries = logEntry.parent()
		logEntry.remove()
		function log(values, cssClass) {
			var entry = logEntry.clone().addClass(cssClass)
			for (var cssClass in values)
				entry.find('.' + cssClass).text(values[cssClass])
			logEntries.append(entry)
		}

		var frames = $('#frames')

		var template = $('.template').hide()

		function loadFrame(title, url, onFinish, onload) {
			function frameLoaded() {
				if (onload) {
					var f = onload
					onload = null
					startTime = new Date().valueOf()
					f(this.contentWindow.$, this.contentWindow.V1, function() { frame.trigger('load') })
				}

				else {
					var endTime = new Date().valueOf()
					var elapsed = (endTime - startTime) / 1000.0
					var locationHref = this.contentWindow.location.href

					instance.addClass('loaded')
						.fadeAway(5000)
						.find('.timing').text(elapsed + ' seconds')
					frame.unbind('load')

					onFinish(elapsed, locationHref)
				}
			}

			var instance = template.clone(false).show()
			instance.find('.title').text(title)
			var frame = instance.find('iframe')
			frame.attr('src', url).load(frameLoaded)
			frames.append(instance)

			var startTime = new Date().valueOf()
		}

		function makeUrl(url, parameters) {
			var needQ = url.indexOf('?') < 0
			var a = [url]
			for (var name in parameters) {
				a.push(needQ ? '?' : '&')
				needQ = false
				a.push(name)
				a.push('=')
				a.push(parameters[name])
			}
			return a.join('')
		}

		function runScenario(index) {
			if (index >= scenarios.length) {
				status('Complete')
				status('', 2)
				return finished()
			}

			var scenario = scenarios[index]

			var url = makeUrl('../' + (scenario.url || defaults.url), scenario.parameters || defaults.parameters)

			var stats = new Stats()
			var note = ''
			var cssClass = 'complete'
			var rounds = 0
			var bust, uniqueUrl

			var minRounds = typeof scenario.minRounds === 'number' ? scenario.minRounds : defaults.minRounds
			var maxRounds = typeof scenario.maxRounds === 'number' ? scenario.maxRounds : defaults.maxRounds
			var targetInterval = typeof scenario.targetInterval === 'number' ? scenario.targetInterval : defaults.targetInterval

			status(scenario.name)
			status('', 'Starting')

			function needARound() {
				//if (rounds >= maxRounds) debugger
				return rounds < maxRounds && (rounds < minRounds || stats.interval() > targetInterval)
			}

			function runNextScenario() { runScenario(index + 1) }

			function finishRound(time, actualUrl) {
				if (actualUrl.qparm('bust') != bust)
				{
					note += 'Wanted ' + uniqueUrl + ' but got ' + actualUrl + '.'
					cssClass = 'warning'
				}
				stats.accumulate(time)
				queueMe()
			}

			function doMe() {
				bust = (new Date()).valueOf()
				uniqueUrl = makeUrl(url, { bust: bust })
				if (scenario.burn) {
					status('Setting Up', 2)
					loadFrame(scenario.name, uniqueUrl, runNextScenario)
				}
				else if (needARound()) {
					++rounds
					var message = 'Round ' + rounds
					if (rounds > 1)
						message += ': ' + stats.median().round(2)
					if (rounds > minRounds)
						message += ' ±' + stats.interval().toPercent(2)
					status(message, 2)
					loadFrame(scenario.name, uniqueUrl, finishRound, scenario.onload)
				}
				else {
					status('Done', 2)
					log(
						{ 
							name: scenario.name, 
							median: stats.median().round(2), 
							interval: '±' + stats.interval().toPercent(2),
							rounds: rounds,
							note: note 
						}, 
						cssClass
					)
					runNextScenario()
				}
			}

			function queueMe() { setTimeout(doMe, 0) }

			queueMe()
		}

		function finished() {
			template.remove()
			//frames.remove()
			statusDiv.fadeAway()
		}

		runScenario(0)
	})

</script>
<style>
.input, BUTTON { margin: 10px }
.input { display: inline-block; }
.input .label { display: block; }
#url { width: 800px; }
.template { width: 400px; border: 2px solid red; display: inline-block; }
.template.loaded { border: 2px solid green; }
.timing, .title { background-color: #F88; height: 20px; text-align: center; }
.loaded .timing, .loaded .title { background-color: #8F8; }
IFRAME { width: 100%; height: 500px; border: 0; }
.output { display: inline-block; border: 1px solid grey; padding: 5px; }
.output .value { background-color: #F88; } 
.output.loaded .value { background-color: #8F8; }
#status { padding: 5px; margin: 5px 0; background-color: Silver; }
#log { border-collapse: collapse; margin: 5px 0; }
#log .number { text-align: right; width: 10em; }
#log .warning { background-color: #F88; }
</style>

</head>
<body>
	
<div id='status'>
	<h1>Not Started</h1>
	<h2></h2>
</div>

<div id='frames'>
</div>

<div class='template'>
	<div class='title'></div>
	<div class='iframe'><iframe></iframe></div>
	<div class='timing'>Loading...</div>
</div>

<table id='log' border='1'>
	<thead>
		<tr>
			<th>Scenario</th>
			<th>median</th>
			<th>50% Interval</th>
			<th>Rounds</th>
			<th>notes</th>
		</tr>
	</thead>
	<tr class='entry'>
		<td class='name'>&nbsp;</td>
		<td class='number median'>&nbsp;</td>
		<td class='number interval'>&nbsp;</td>
		<td class='number rounds'>&nbsp;</td>
		<td class='note'>&nbsp;</td>
	</tr>
</table>

</body>
</html>